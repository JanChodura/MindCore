-- OBSERVER FLOW (MINDRISE-SPECIFIC VERSION WITH CUSTOM TRIGGER RESULTS AND CONSUMERS)
-- ====================================================================================

-- 1. EventTriggersModule (Dependency Injection configuration)
-- -------------------------------------------------------------
-- Defines all application triggers and groups them into contexts.
-- Each trigger is represented by a TriggerContext:
--   - event: unique name of the trigger
--   - trigger: implementation of IAppTrigger (e.g., MorningResetTrigger)
--   - triggerPoll: individual polling instance
--
-- Example Hilt bindings:
--   @Named("ConvictionTriggers") → Conviction-related triggers for ConvictionViewModel
--   @Named("DefaultTriggers")    → Global triggers active for all screens
--
-- → This is the registration layer that wires the entire observer system.

-- 2. AppObserver (Event Orchestrator)
-- -----------------------------------
-- Core responsibilities:
--   - Receives triggersFlow (StateFlow<List<TriggerContext>>) injected by Hilt.
--   - Initializes TriggerPollingManager with all triggers.
--   - Observes ActiveScreenTracker for screen changes.
--   - Starts or restarts polling whenever the user changes screens.
--   - Collects TriggerResult from TriggerPollingManager and passes it
--     to TriggerResultConsumer for application-specific handling.
--
-- Output actions (delegated through TriggerResultConsumer):
--   - Navigate to conviction screen first page.
--   - Show dialogs or messages.
--   - Execute generic or app-specific actions.
--
-- → AppObserver is the reactive control tower of the system.

-- 3. TriggerPollingManager (Coordinator of trigger polls)
-- --------------------------------------------------------
-- Manages per-trigger pollers and dispatches their results.
-- Responsibilities:
--   - Holds all TriggerContext instances.
--   - Configures TriggerPolls with cycle count, interval, and scope.
--   - Observes tickFlow for each trigger and invokes trigger.tryExecute().
--   - Emits a TriggerResult for every meaningful trigger output.
--
-- Emits:
--   - TriggerResult.None                  → no effect
--   - TriggerResult.NavigateToScreenFirstPage
--   - TriggerResult.ExecuteAction
--   - TriggerResult.Generic(payload)
--
-- → This is the scheduling and event distribution center.

-- 4. TriggerPoll (Time-based ticker)
-- -----------------------------------
-- Each TriggerPoll is tied to a single TriggerContext.
--   - Emits periodic ticks (LocalTime) for a defined interval and duration.
--   - Can be configured dynamically:
--         attachScope(scope)
--         attachInterval(seconds)
--         attachCycles(count)
--         attachSource(source)
--         start()
--
-- → This is the temporal heartbeat driving trigger evaluation.

-- 5. IAppTrigger IMPLEMENTATIONS (Concrete Triggers)
-- ---------------------------------------------------
-- Each trigger defines its own logic and outputs a TriggerResult.
--
-- Example: MorningResetTrigger
--   - Checks repository.wasResetToday()
--   - Ensures reset runs once per morning window (2:00–8:00)
--   - Navigates user to Convictions screen (page 0)
--   - Returns TriggerResult.NavigateToScreenFirstPage(Screen.Convictions, 0)
--
-- Contract:
--   suspend fun tryExecute(): TriggerResult
--
-- → These are behavioral units that encapsulate "what should happen and when".

-- 6. TriggerResult (Unified output contract)
-- ------------------------------------------
-- Standard results available across all modules:
--   - None → No action.
--   - NavigateToScreenFirstPage(screen, pageId)
--   - ShowDialog(message)
--   - ExecuteAction(actionId)
--   - Generic(payload: Any)
--
-- → The Generic variant allows application-specific payloads,
--   enabling extended trigger communication (custom trigger effects).

-- 7. MindRiseTriggerResult (App-specific sealed class)
-- -----------------------------------------------------
-- Defines domain-specific trigger outcomes for MindRise:
--   - StartHabitActivityConvictionRead(actionId: String)
--   - ConvictionScreenInitialized(initialized: Boolean)
--
-- These values are usually wrapped inside TriggerResult.Generic(payload).

-- 8. MindRiseTriggerResultConsumer (Custom consumer)
-- ---------------------------------------------------
-- Implements TriggerResultConsumer for MindRise app.
--   - Handles all standard TriggerResult variants.
--   - Adds logic for Generic results containing MindRiseTriggerResult payloads.
--
-- Example:
--   if (result is TriggerResult.Generic &&
--       result.payload is MindRiseTriggerResult.StartHabitActivityConvictionRead) {
--       // launch habit reading activity
--   }
--
-- Core actions:
--   - tracker.setActiveScreen() for navigation.
--   - logger.d() for ShowDialog or ExecuteAction.
--
-- → This class adapts framework-level trigger results to real app behavior.

-- 9. FULL OBSERVER FLOW (MindRise-specific)
-- ------------------------------------------
--  User Action / Time Event
--       ↓
--  ActiveScreenTracker (detects screen changes)
--       ↓
--  AppObserver (initializes and orchestrates trigger evaluation)
--       ↓
--  TriggerPollingManager (manages per-trigger lifecycle)
--       ↓
--  TriggerPoll  →  IAppTrigger.tryExecute()
--       ↓
--  TriggerResult (Navigate / Dialog / Action / Generic)
--       ↓
--  MindRiseTriggerResultConsumer.consume(result)
--       ↓
--  ActiveScreenTracker / ViewModel / UI (update or navigation)
--
-- → The system ensures triggers are evaluated asynchronously and consumed
--   safely on the application level, supporting both core framework results
--   and app-specific trigger effects.

-- Summary:
-- ----------
-- The MindRise observer system is an extensible event-driven framework.
-- It blends coroutine-based timing, modular DI, and reactive state flow,
-- allowing both global and per-feature trigger orchestration.
--
-- Each layer answers a single architectural question:
--   - Trigger: “What should happen?”
--   - TriggerPoll: “When should it happen?”
--   - TriggerPollingManager: “How do we coordinate it?”
--   - AppObserver: “Why and under what app context?”
--   - TriggerResultConsumer: “How does the app respond?”
--
-- Together, they form a clean, testable flow from event detection to user-facing behavior.
